<!DOCTYPE html>
<html lang="es">
<head>
    <div th:replace="~{fragments/head.html}"></div>
</head>
<div th:replace="~{fragments/links.html}"></div>
<style>
    .menu-item {
        border-radius: 15px;
        text-align: center;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 150px;
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .menu-item:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    .menu-item-add {
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(10px);
        border: 2px dashed #ccc;
    }

    .menu-item-add:hover {
        border-color: #4A90E2;
        background: rgba(255, 255, 255, 0.8);
    }

    .icon-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 12px;
    }

    .icon-circle img {
        width: 50%;
        height: 50%;
        object-fit: contain;
    }

    .hover-overlay .overlay {
        background: rgba(0, 0, 0, 0.5);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .hover-overlay:hover .overlay {
        opacity: 1;
    }

    .hover-opacity:hover {
        opacity: 1 !important;
    }

    .transition {
        transition: opacity 0.3s ease;
    }

    .cursor-pointer {
        cursor: pointer;
    }
</style>

<body class="d-flex flex-column min-vh-100">
<div th:replace="~{fragments/preloader.html}"></div>
<div th:replace="~{fragments/video_background.html}"></div>

<section class="container py-4">
    <div class="row g-4 text-center">
        <div th:each="centro : ${centros}" class="col-12 col-sm-6 col-lg-3">
            <div class="card h-100 menu-item" th:data-idcentro="${centro.id}"
                 onclick="location.href='/' + this.dataset.idcentro + '/menu'">
                <div class="card-body">
                    <button class="btn p-0 border-0 bg-transparent position-absolute top-0 end-0 m-2 star-btn"
                            th:data-idcentro="${centro.id}" th:data-fav="${centro.favorito}"
                            onclick="event.stopPropagation(); toggleStar(this)">
                        <i class="bi fs-4"
                           th:classappend="${centro.favorito ? 'bi-star-fill text-warning' : 'bi-star text-secondary'}"></i>
                    </button>

                    <div class="d-flex justify-content-center align-items-center">
                        <div class="rounded-circle position-relative overflow-hidden mx-auto mb-3 hover-overlay"
                             style="width: 120px; height: 120px;">
                            <img th:src="@{'/centros/' + ${centro.id} + '/logo'}"
                                 th:alt="${centro.nombre}"
                                 width="80%"
                                 class="position-absolute top-50 start-50 translate-middle">
                            <div class="overlay position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center"
                                 th:data-idcentro="${centro.id}"
                                 onclick="event.stopPropagation();modalCentro(this.dataset.idcentro)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="white"
                                     class="bi bi-pencil" viewBox="0 0 16 16">
                                    <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325"/>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <h6 class="card-title text-dark fw-bold" th:text="${centro.nombre}"></h6>
                </div>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card h-100 menu-item menu-item-add" onclick="event.stopPropagation();modalCentro(null)">
                <div class="card-body">
                    <div class="d-flex justify-content-center align-items-center mx-auto mb-3"
                         style="width: 120px; height: 120px;">
                        <svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="40" cy="40" r="38" fill="none" stroke="#0d6efd" stroke-width="2"
                                    stroke-dasharray="5,5"/>
                            <line x1="40" y1="20" x2="40" y2="60" stroke="#0d6efd" stroke-width="3"
                                  stroke-linecap="round"/>
                            <line x1="20" y1="40" x2="60" y2="40" stroke="#0d6efd" stroke-width="3"
                                  stroke-linecap="round"/>
                        </svg>
                    </div>
                    <h6 class="card-title text-dark fw-bold">Añadir centro</h6>
                </div>
            </div>
        </div>
    </div>
</section>

<div th:replace="~{fragments/footer.html}"></div>

</body>

<form method="post" id="toggleFav" action="/centros/fav">
    <input type="hidden" name="idCentro" id="idCentro">
    <input type="hidden" name="fav" id="fav">
</form>
<!-- Modal -->
<div class="modal fade" id="centroModal" tabindex="-1" aria-labelledby="centroModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <!-- Encabezado -->
            <div class="modal-header border-0 rounded-top-4">
                <h5 class="modal-title fw-semibold" id="header">Nuevo centro</h5>
                <button id="btnStar" class="btn p-0 border-0 bg-transparent position-absolute top-0 end-0 m-2 star-btn"
                        onclick="event.stopPropagation(); enableStar(this)">
                    <i class="bi fs-4 bi-star text-secondary"></i>
                </button>
            </div>

            <!-- Cuerpo -->
            <div class="modal-body p-4">
                <form action="/centros" method="post" id="centroForm" th:object="${centroDTO}"
                      enctype="multipart/form-data">
                    <input id="id" type="hidden" th:field="*{id}">
                    <div class="row">
                        <div class="col-4 d-flex justify-content-center align-items-center">
                            <!-- Imagen con overlay -->
                            <div class="d-flex justify-content-center align-items-center position-relative mx-auto mb-3"
                                 style="width: 120px; height: 120px;">
                                <div class="d-flex justify-content-center align-items-center rounded-circle mx-auto shadow-sm"
                                     style="width: 120px; height: 120px; font-size: 2rem; overflow: hidden; border: 2px solid #0d6efd;">
                                    <img id="previewImage" src="/images/centro_sin_logo.png" alt="logo" width="80%"/>
                                </div>

                                <!-- Overlay -->
                                <div class="position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center rounded-circle bg-dark bg-opacity-50 opacity-0 hover-opacity transition">
                                    <label for="logo"
                                           class="cursor-pointer text-white d-flex flex-column align-items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="white"
                                             class="bi bi-camera" viewBox="0 0 16 16">
                                            <path d="M15 12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h1.172a3 3 0 0 0 2.12-.879l.83-.828A1 1 0 0 1 6.827 3h2.344a1 1 0 0 1 .707.293l.828.828A3 3 0 0 0 12.828 5H14a1 1 0 0 1 1 1zM2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4z"/>
                                            <path d="M8 11a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5m0 1a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7M3 6.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0"/>
                                        </svg>
                                    </label>
                                    <input id="logo" type="file" accept="image/*" class="d-none" th:field="*{logo}"
                                           onchange="previewFile(event)">
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="newCentrofav" th:field="*{favorito}">
                        <div class="col-8">
                            <!-- Nombre -->
                            <div class="mb-3">
                                <label for="nombre" class="form-label fw-semibold">Nombre</label>
                                <input type="text" class="form-control rounded-3" id="nombre"
                                       placeholder="Introduce un nombre..." th:field="*{nombre}">
                            </div>

                            <!-- Descripción -->
                            <div class="mb-3">
                                <label for="descripcion" class="form-label fw-semibold">Descripción</label>
                                <textarea class="form-control rounded-3" id="descripcion" rows="3"
                                          placeholder="Escribe una breve descripción..."
                                          th:field="*{descripcion}"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Pie -->
            <div class="modal-footer border-0 bg-light rounded-bottom-4">
                <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">Cancelar
                </button>
                <button type="button" class="btn btn-primary rou	nded-pill px-4" onclick="$('#centroForm').submit()">
                    Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    async function modalCentro(idCentro) {
        initPreloader();
        const id = document.getElementById('id');
        id.value = idCentro;
        const header = document.getElementById('header');
        const nombre = document.getElementById('nombre');
        const descripcion = document.getElementById('descripcion');
        const logoInput = document.getElementById('logo');
        const logoImg = document.getElementById('previewImage');

        if (idCentro != null && idCentro !== 0) {
            header.textContent = "Editar centro";

            try {
                const response = await fetch(`/centros/${idCentro}`);
                if (!response.ok) throw new Error("Error al cargar el centro");
                const centro = await response.json();
                nombre.value = centro.nombre;
                descripcion.value = centro.descripcion;
                if(centro.favorito){
                    enableStar($('#btnStar'));
                }
                logoImg.src = `/centros/${idCentro}/logo`;

                new bootstrap.Modal(document.getElementById('centroModal')).show();
            } catch (err) {
                console.error(err);
                showMsg("E", "No se pudo cargar la información del centro")
            } finally {
                stopPreloader();
            }
        } else {
            header.textContent = "Nuevo centro";
            nombre.value = "";
            descripcion.value = "";
            logoInput.value = "";
            logoImg.src = "/images/centro_sin_logo.png";
            new bootstrap.Modal(document.getElementById('centroModal')).show();
            stopPreloader();
        }
    }


    function toggleStar(btn) {
        $('#idCentro').val(btn.dataset.idcentro);
        $('#fav').val(btn.dataset.fav !== 'true');
        $('#toggleFav').submit();
    }

    function enableStar(btn) {
        const icon = btn.querySelector("i");
        if (icon.classList.contains("bi-star")) {
            icon.classList.replace("bi-star", "bi-star-fill");
            icon.classList.replace("text-secondary", "text-warning");
            $('#newCentrofav').val('true');
        } else {
            icon.classList.replace("bi-star-fill", "bi-star");
            icon.classList.replace("text-warning", "text-secondary");
            $('#newCentrofav').val('false');
        }
    }

    function previewFile(event) {
        const reader = new FileReader();
        reader.onload = function () {
            const output = document.getElementById('previewImage');
            output.src = reader.result;
        };
        reader.readAsDataURL(event.target.files[0]);
    }
</script>
</html>